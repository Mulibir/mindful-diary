<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindful Diary</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f3e8ff 0%, #e0f2fe 100%);
            color: #333;
            max-width: 428px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #8b5cf6;
            color: #8b5cf6;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .search-bar {
            padding: 15px;
        }
        .search-bar input {
            width: 90%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        #addButton {
            display: block;
            margin: 0 auto 20px auto;
            padding: 12px 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .form-container {
            background: white;
            margin: 0 10px 20px 10px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .hidden { display: none; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .rating-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .rating-scale {
            display: flex;
            gap: 5px;
        }
        .rating-number {
            width: 30px;
            height: 30px;
            border: 2px solid #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .rating-number.selected {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }
        .save-btn, .close-btn {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #entriesContainer { padding: 0 10px 30px 10px; }
        .entry {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #8b5cf6;
        }
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .entry-time-badge {
            background: #f3e8ff;
            color: #7c3aed;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .mindfulness-score {
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .analytics-container {
            padding: 15px;
        }
        .backup-container {
            padding: 15px;
        }
        .stats-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .backup-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #10b981;
        }
        .stats-title {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }
        .stats-value {
            font-size: 24px;
            font-weight: bold;
            color: #8b5cf6;
        }
        .time-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .time-stat {
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .backup-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
        }
        .export-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
        }
        .import-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
        }
        .email-setup {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .progress-chart {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        #fileInput {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üßò‚Äç‚ôÄÔ∏è Mindful Diary</h1>
        <p>Track your meditation journey with insights</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('journal')">üìù Journal</button>
        <button class="tab" onclick="switchTab('analytics')">üìä Analytics</button>
        <button class="tab" onclick="switchTab('backup')">üõ°Ô∏è Backup</button>
    </div>

    <!-- Journal Tab -->
    <div id="journal" class="tab-content active">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search your reflections...">
        </div>

        <button id="addButton">+ New Meditation Reflection</button>

        <div id="formContainer" class="form-container hidden">
            <div class="form-header">
                <h2>New Reflection</h2>
                <button id="closeButton" class="close-btn">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="dateInput">
            </div>
            
            <div class="form-group">
                <label>Time of Day</label>
                <select id="timeOfDaySelect">
                    <option value="morning">üåÖ Morning</option>
                    <option value="afternoon">‚òÄÔ∏è Afternoon</option>
                    <option value="evening">üåÖ Evening</option>
                    <option value="bedtime">üåô Before Bed</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Duration (minutes)</label>
                <input type="number" id="durationInput" placeholder="e.g., 20">
            </div>
            
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="locationInput" placeholder="e.g., Living room, Park">
            </div>
            
            <div class="rating-group">
                <label style="margin-bottom: 0;">Mindfulness Level (1-10):</label>
                <div class="rating-scale" id="ratingScale">
                    <div class="rating-number" data-rating="1">1</div>
                    <div class="rating-number" data-rating="2">2</div>
                    <div class="rating-number" data-rating="3">3</div>
                    <div class="rating-number" data-rating="4">4</div>
                    <div class="rating-number" data-rating="5">5</div>
                    <div class="rating-number" data-rating="6">6</div>
                    <div class="rating-number" data-rating="7">7</div>
                    <div class="rating-number" data-rating="8">8</div>
                    <div class="rating-number" data-rating="9">9</div>
                    <div class="rating-number" data-rating="10">10</div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Mood After Meditation</label>
                <select id="moodSelect">
                    <option value="peaceful">üòå Peaceful</option>
                    <option value="grateful">üôè Grateful</option>
                    <option value="focused">üéØ Focused</option>
                    <option value="happy">üòä Happy</option>
                    <option value="neutral" selected>üòê Neutral</option>
                    <option value="restless">üò§ Restless</option>
                    <option value="anxious">üò∞ Anxious</option>
                    <option value="sad">üò¢ Sad</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Thoughts & Reflections</label>
                <textarea id="thoughtsInput" placeholder="What thoughts came up during meditation? How did you feel?"></textarea>
            </div>
            
            <button id="saveButton" class="save-btn">üíæ Save Reflection</button>
        </div>

        <div id="entriesContainer"></div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
        <div class="analytics-container">
            <div class="stats-card">
                <div class="stats-title">This Week's Average</div>
                <div class="stats-value" id="weeklyAverage">-</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">Mindfulness Level</div>
            </div>

            <div class="stats-card">
                <div class="stats-title">Total Sessions</div>
                <div class="stats-value" id="totalSessions">0</div>
            </div>

            <div class="stats-card">
                <div class="stats-title">Best Time for Meditation</div>
                <div style="font-size: 18px; font-weight: bold; color: #10b981;" id="bestTime">-</div>
                <div class="time-stats">
                    <div class="time-stat">
                        <div style="font-weight: bold;">üåÖ Morning</div>
                        <div id="morningAvg">-</div>
                    </div>
                    <div class="time-stat">
                        <div style="font-weight: bold;">‚òÄÔ∏è Afternoon</div>
                        <div id="afternoonAvg">-</div>
                    </div>
                    <div class="time-stat">
                        <div style="font-weight: bold;">üåÖ Evening</div>
                        <div id="eveningAvg">-</div>
                    </div>
                    <div class="time-stat">
                        <div style="font-weight: bold;">üåô Before Bed</div>
                        <div id="bedtimeAvg">-</div>
                    </div>
                </div>
            </div>

            <div class="progress-chart">
                <div class="stats-title">Recent Progress</div>
                <div id="progressChart">
                    <div style="color: #666; text-align: center; padding: 20px;">
                        Add more reflections to see your progress chart
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Tab -->
    <div id="backup" class="tab-content">
        <div class="backup-container">
            <div class="email-setup">
                <div style="font-weight: bold; margin-bottom: 10px;">üìß Weekly Email Summaries</div>
                <div style="font-size: 14px; margin-bottom: 10px;">Get automatic weekly backups sent to your email!</div>
                <input type="email" id="emailInput" placeholder="Enter your email address" 
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box;">
                <button onclick="setupEmailBackup()" class="backup-btn">üìß Setup Weekly Email Backup</button>
                <div id="emailStatus" style="font-size: 12px; margin-top: 5px;"></div>
            </div>

            <div class="backup-card">
                <div class="stats-title">üõ°Ô∏è Manual Backup Options</div>
                
                <button onclick="exportData()" class="export-btn">
                    üì§ Export All Data
                    <div style="font-size: 12px; margin-top: 2px;">Download backup file</div>
                </button>
                
                <button onclick="emailCurrentData()" class="backup-btn">
                    üìß Email Current Data
                    <div style="font-size: 12px; margin-top: 2px;">Send all data to your email now</div>
                </button>
                
                <div style="margin: 15px 0; border-top: 1px solid #e5e7eb; padding-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">üì• Restore Data</div>
                    <input type="file" id="fileInput" accept=".json" style="margin-bottom: 8px;">
                    <button onclick="importData()" class="import-btn">
                        üì• Import Backup File
                        <div style="font-size: 12px; margin-top: 2px;">Restore from exported file</div>
                    </button>
                </div>
            </div>

            <div class="backup-card">
                <div class="stats-title">üìä Backup Status</div>
                <div id="backupStatus">
                    <div style="font-size: 14px; color: #666;">
                        Last backup: <span id="lastBackup">Never</span><br>
                        Total entries: <span id="totalEntries">0</span><br>
                        Email backup: <span id="emailBackupStatus">Not set up</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let entries = [];
        let selectedRating = 5;
        let userEmail = '';
        
        // Try to load from localStorage
        try {
            const saved = localStorage.getItem('mindfulDiaryEntries');
            if (saved) {
                entries = JSON.parse(saved);
            }
            const savedEmail = localStorage.getItem('mindfulDiaryEmail');
            if (savedEmail) {
                userEmail = savedEmail;
                document.getElementById('emailInput').value = userEmail;
            }
        } catch (error) {
            console.log('localStorage not available');
        }

        document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

        const moodEmojis = {
            peaceful: 'üòå', grateful: 'üôè', focused: 'üéØ', restless: 'üò§',
            sad: 'üò¢', neutral: 'üòê', happy: 'üòä', anxious: 'üò∞'
        };

        const timeEmojis = {
            morning: 'üåÖ', afternoon: '‚òÄÔ∏è', evening: 'üåÖ', bedtime: 'üåô'
        };

        const timeLabels = {
            morning: 'Morning', afternoon: 'Afternoon', evening: 'Evening', bedtime: 'Before Bed'
        };

        // Rating system
        document.querySelectorAll('.rating-number').forEach(num => {
            num.addEventListener('click', () => {
                document.querySelectorAll('.rating-number').forEach(n => n.classList.remove('selected'));
                num.classList.add('selected');
                selectedRating = parseInt(num.dataset.rating);
            });
        });

        // Set default rating
        document.querySelector('.rating-number[data-rating="5"]').classList.add('selected');

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'backup') {
                updateBackupStatus();
            }
        }

        // Event listeners
        document.getElementById('addButton').addEventListener('click', () => {
            document.getElementById('formContainer').classList.remove('hidden');
            document.getElementById('addButton').style.display = 'none';
        });

        document.getElementById('closeButton').addEventListener('click', () => {
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('addButton').style.display = 'block';
            clearForm();
        });

        document.getElementById('saveButton').addEventListener('click', saveEntry);
        document.getElementById('searchInput').addEventListener('input', handleSearch);

        function clearForm() {
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            document.getElementById('durationInput').value = '';
            document.getElementById('locationInput').value = '';
            document.getElementById('moodSelect').value = 'neutral';
            document.getElementById('thoughtsInput').value = '';
            document.getElementById('timeOfDaySelect').value = 'morning';
            
            // Reset rating
            document.querySelectorAll('.rating-number').forEach(n => n.classList.remove('selected'));
            document.querySelector('.rating-number[data-rating="5"]').classList.add('selected');
            selectedRating = 5;
        }

        function saveEntry() {
            const thoughts = document.getElementById('thoughtsInput').value.trim();
            if (!thoughts) {
                alert('Please enter your thoughts and reflections');
                return;
            }

            const entry = {
                id: Date.now(),
                date: document.getElementById('dateInput').value,
                timeOfDay: document.getElementById('timeOfDaySelect').value,
                duration: document.getElementById('durationInput').value,
                location: document.getElementById('locationInput').value,
                mood: document.getElementById('moodSelect').value,
                mindfulnessRating: selectedRating,
                thoughts: thoughts,
                timestamp: new Date().toISOString()
            };

            entries.unshift(entry);
            
            try {
                localStorage.setItem('mindfulDiaryEntries', JSON.stringify(entries));
            } catch (error) {
                console.log('Could not save to localStorage');
            }
            
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('addButton').style.display = 'block';
            clearForm();
            renderEntries();

            // Check if we should send weekly summary
            checkWeeklySummary();
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredEntries = entries;
            if (searchTerm) {
                filteredEntries = entries.filter(entry =>
                    entry.thoughts.toLowerCase().includes(searchTerm) ||
                    (entry.location && entry.location.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredEntries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 15px;">üßò‚Äç‚ôÄÔ∏è</div>
                        <p>${searchTerm ? 'No reflections found' : 'Start your mindful journey'}</p>
                    </div>
                `;
            } else {
                container.innerHTML = filteredEntries.map(entry => `
                    <div class="entry">
                        <div class="entry-header">
                            <div>
                                <strong>üìÖ ${formatDate(entry.date)}</strong>
                                <span class="entry-time-badge">${timeEmojis[entry.timeOfDay]} ${timeLabels[entry.timeOfDay]}</span>
                            </div>
                            <span class="mindfulness-score">üéØ ${entry.mindfulnessRating}/10</span>
                        </div>
                        ${entry.duration ? `<div><strong>Duration:</strong> ${entry.duration} min</div>` : ''}
                        <div><strong>Mood:</strong> ${moodEmojis[entry.mood]}</div>
                        ${entry.location ? `<div><strong>Location:</strong> ${entry.location}</div>` : ''}
                        <div style="margin-top: 8px;"><strong>Thoughts:</strong></div>
                        <div style="font-style: italic; color: #555; margin-top: 4px;">${entry.thoughts}</div>
                    </div>
                `).join('');
            }
        }

        function handleSearch() {
            renderEntries();
        }

        function updateAnalytics() {
            if (entries.length === 0) return;

            // Calculate weekly average (last 7 days)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const weeklyEntries = entries.filter(entry => new Date(entry.date) >= oneWeekAgo);
            const weeklyAvg = weeklyEntries.length > 0 
                ? (weeklyEntries.reduce((sum, entry) => sum + entry.mindfulnessRating, 0) / weeklyEntries.length).toFixed(1)
                : '-';
            
            document.getElementById('weeklyAverage').textContent = weeklyAvg;
            document.getElementById('totalSessions').textContent = entries.length;

            // Calculate averages by time of day
            const timeStats = {
                morning: [],
                afternoon: [],
                evening: [],
                bedtime: []
            };

            entries.forEach(entry => {
                if (timeStats[entry.timeOfDay]) {
                    timeStats[entry.timeOfDay].push(entry.mindfulnessRating);
                }
            });

            const timeAverages = {};
            let bestTimeOfDay = '';
            let bestAverage = 0;

            Object.keys(timeStats).forEach(time => {
                const ratings = timeStats[time];
                if (ratings.length > 0) {
                    const avg = (ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length).toFixed(1);
                    timeAverages[time] = avg;
                    
                    if (parseFloat(avg) > bestAverage) {
                        bestAverage = parseFloat(avg);
                        bestTimeOfDay = time;
                    }
                } else {
                    timeAverages[time] = '-';
                }
            });

            document.getElementById('morningAvg').textContent = timeAverages.morning;
            document.getElementById('afternoonAvg').textContent = timeAverages.afternoon;
            document.getElementById('eveningAvg').textContent = timeAverages.evening;
            document.getElementById('bedtimeAvg').textContent = timeAverages.bedtime;
            
            document.getElementById('bestTime').textContent = bestTimeOfDay 
                ? `${timeEmojis[bestTimeOfDay]} ${timeLabels[bestTimeOfDay]} (${timeAverages[bestTimeOfDay]}/10)`
                : '-';
        }

        // Backup Functions
        function setupEmailBackup() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            userEmail = email;
            try {
                localStorage.setItem('mindfulDiaryEmail', email);
                localStorage.setItem('mindfulDiaryEmailSetup', new Date().toISOString());
            } catch (error) {
                console.log('Could not save email');
            }
            
            document.getElementById('emailStatus').innerHTML = 
                '<span style="color: #10b981;">‚úÖ Email backup set up successfully!</span>';
            
            // Send initial welcome email
            emailCurrentData(true);
        }

        function exportData() {
            const dataStr = JSON.stringify(entries, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `mindful-diary-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            // Update last backup time
            try {
                localStorage.setItem('lastBackup', new Date().toISOString());
            } catch (error) {
                console.log('Could not save backup time');
            }
            
            updateBackupStatus();
        }

        function importData() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a backup file first');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedEntries = JSON.parse(e.target.result);
                    
                    if (confirm(`This will import ${importedEntries.length} entries. Continue?`)) {
                        entries = importedEntries;
                        try {
                            localStorage.setItem('mindfulDiaryEntries', JSON.stringify(entries));
                        } catch (error) {
                            console.log('Could not save imported data');
                        }
                        renderEntries();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Invalid backup file format');
                }
            };
            reader.readAsText(file);
        }

        function emailCurrentData(isWelcome = false) {
            if (!userEmail) {
                alert('Please set up email backup first');
                return;
            }
            
            const subject = isWelcome ? 
                'Welcome to Mindful Diary - Email Backup Activated' : 
                'Mindful Diary - Data Backup';
            
            const weeklyStats = generateWeeklyStats();
            const allTimeStats = generateAllTimeStats();
            
            const emailBody = `
Hi there! üßò‚Äç‚ôÄÔ∏è

${isWelcome ? 
    'Welcome to Mindful Diary! Your email backup is now set up and working.' : 
    'Here\'s your meditation data backup and weekly summary.'}

üìä WEEKLY SUMMARY:
${weeklyStats}

üìà ALL-TIME STATS:
${allTimeStats}

üíæ DATA BACKUP:
Total meditation sessions: ${entries.length}
Data as of: ${new Date().toLocaleString()}

            ${entries.length > 0 ? 
    `üßò‚Äç‚ôÄÔ∏è RECENT REFLECTIONS:\n${entries.slice(0, 5).map(entry => 
        `‚Ä¢ ${entry.date} (${timeLabels[entry.timeOfDay]}) - Mindfulness: ${entry.mindfulnessRating}/10\n  "${entry.thoughts.substring(0, 100)}${entry.thoughts.length > 100 ? '...' : ''}"`
    ).join('\n\n')}` : 'No reflections yet - start your mindful journey!'}

Keep up your wonderful meditation practice! üåü

With love,
Your Mindful Diary App

---
This is an automated backup from your Mindful Diary app.
To restore this data, save this email and use the Import feature in the Backup tab.
            `.trim();
            
            // Create mailto link
            const mailtoLink = `mailto:${userEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            // Open email client
            window.location.href = mailtoLink;
            
            // Update last backup time
            try {
                localStorage.setItem('lastBackup', new Date().toISOString());
            } catch (error) {
                console.log('Could not save backup time');
            }
            
            updateBackupStatus();
        }

        function generateWeeklyStats() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const weeklyEntries = entries.filter(entry => new Date(entry.date) >= oneWeekAgo);
            
            if (weeklyEntries.length === 0) {
                return 'No meditation sessions this week - time to get back to practice! üßò‚Äç‚ôÄÔ∏è';
            }
            
            const avgRating = (weeklyEntries.reduce((sum, entry) => sum + entry.mindfulnessRating, 0) / weeklyEntries.length).toFixed(1);
            const totalMinutes = weeklyEntries.reduce((sum, entry) => sum + (parseInt(entry.duration) || 0), 0);
            
            return `
‚Ä¢ Sessions this week: ${weeklyEntries.length}
‚Ä¢ Average mindfulness: ${avgRating}/10
‚Ä¢ Total meditation time: ${totalMinutes} minutes
‚Ä¢ Most peaceful session: ${Math.max(...weeklyEntries.map(e => e.mindfulnessRating))}/10`;
        }

        function generateAllTimeStats() {
            if (entries.length === 0) {
                return 'No data yet - start your meditation journey today!';
            }
            
            const totalMinutes = entries.reduce((sum, entry) => sum + (parseInt(entry.duration) || 0), 0);
            const avgRating = (entries.reduce((sum, entry) => sum + entry.mindfulnessRating, 0) / entries.length).toFixed(1);
            const bestRating = Math.max(...entries.map(e => e.mindfulnessRating));
            
            // Find best time of day
            const timeStats = { morning: [], afternoon: [], evening: [], bedtime: [] };
            entries.forEach(entry => {
                if (timeStats[entry.timeOfDay]) {
                    timeStats[entry.timeOfDay].push(entry.mindfulnessRating);
                }
            });
            
            let bestTime = '';
            let bestAvg = 0;
            Object.keys(timeStats).forEach(time => {
                if (timeStats[time].length > 0) {
                    const avg = timeStats[time].reduce((sum, rating) => sum + rating, 0) / timeStats[time].length;
                    if (avg > bestAvg) {
                        bestAvg = avg;
                        bestTime = timeLabels[time];
                    }
                }
            });
            
            return `
‚Ä¢ Total sessions: ${entries.length}
‚Ä¢ Total meditation time: ${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m
‚Ä¢ Average mindfulness: ${avgRating}/10
‚Ä¢ Best session ever: ${bestRating}/10
‚Ä¢ Best time of day: ${bestTime} (${bestAvg.toFixed(1)}/10)`;
        }

        function checkWeeklySummary() {
            if (!userEmail) return;
            
            try {
                const lastSummary = localStorage.getItem('lastWeeklySummary');
                const now = new Date();
                
                if (!lastSummary) {
                    localStorage.setItem('lastWeeklySummary', now.toISOString());
                    return;
                }
                
                const lastSummaryDate = new Date(lastSummary);
                const daysDiff = Math.floor((now - lastSummaryDate) / (1000 * 60 * 60 * 24));
                
                // Send weekly summary if it's been 7 days and we have recent entries
                if (daysDiff >= 7) {
                    const recentEntries = entries.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return (now - entryDate) / (1000 * 60 * 60 * 24) <= 7;
                    });
                    
                    if (recentEntries.length > 0) {
                        setTimeout(() => {
                            if (confirm('üìß Send your weekly meditation summary via email?')) {
                                emailCurrentData();
                                localStorage.setItem('lastWeeklySummary', now.toISOString());
                            }
                        }, 1000);
                    }
                }
            } catch (error) {
                console.log('Could not check weekly summary');
            }
        }

        function updateBackupStatus() {
            try {
                const lastBackup = localStorage.getItem('lastBackup');
                const emailSetup = localStorage.getItem('mindfulDiaryEmailSetup');
                
                document.getElementById('lastBackup').textContent = lastBackup 
                    ? new Date(lastBackup).toLocaleDateString() 
                    : 'Never';
                    
                document.getElementById('totalEntries').textContent = entries.length;
                
                document.getElementById('emailBackupStatus').textContent = emailSetup 
                    ? `‚úÖ Active (${userEmail})` 
                    : '‚ùå Not set up';
            } catch (error) {
                console.log('Could not update backup status');
            }
        }

        // Initialize
        renderEntries();
        updateAnalytics();
        updateBackupStatus();

        // Check for weekly summary on load
        setTimeout(checkWeeklySummary, 2000);
    </script>
</body>
</html>
